var encadenadas_automaticas=10,first=!0,nextConcatenated=null,finger=null,feedback=[],isReading=null,firstReading=!0,currentNew=null,currentIdRecomendation=null,coronita_finished=!1,coronita_load_more_content_selector="*[data-load-more-content]",idSig=cb_options.news_loaded=0,chainedShowed=[],idWordpressEN="",slotsSf="",storeLinksSlotsSf=[],storeLinksChainedSf=[],chainedSf="",sfLoaded=!1,delaySeconds=10,sostenibilidadURL=!1,saludFinancieraURL=!1,juntosURL=!1,innovacionURL=!1,urlActual=window.location.href,listEncadenadas="",firstIdNewsReading=digitalData.news.id,totalIdsRelac=[firstIdNewsReading],typeRecommend="",sfEnableScenarioUrlCookie="";function getChainedSf(){if(chainedSf)for(var e=0;e<chainedSf.length;e++){var t=chainedSf[e].content_id;if(!chainedShowed.includes(t))return chainedShowed.push(t),storeLinksChainedSf.push({content_id:chainedSf[e].content_id,link:chainedSf[e].link}),chainedSf.shift(),t;chainedSf.shift()}return!1}function salesforceCall(){var e=getCookie("salesforceCookieNueva");if(""!==e&&"vacio"!==e){e=e.split(",");if(sostenibilidadURL)sfEnableScenarioUrlCookie=e[3],sfEnableScenarioUrl=e[3]+trackPostID;else if(saludFinancieraURL)sfEnableScenarioUrlCookie=e[4],sfEnableScenarioUrl=e[4]+trackPostID;else if(juntosURL)sfEnableScenarioUrlCookie=e[5],sfEnableScenarioUrl=e[5]+trackPostID;else if(innovacionURL)sfEnableScenarioUrlCookie=e[6],sfEnableScenarioUrl=e[6]+trackPostID;else{if(""===e[1])return;sfEnableScenarioUrlCookie=e[1],sfEnableScenarioUrl=e[1]+trackPostID}delaySeconds=e[2],$.ajax({type:"GET",url:sfEnableScenarioUrl,dataType:"jsonp",success:function(e,t,n){sfLoaded=!0,sostenibilidadURL||saludFinancieraURL||juntosURL||innovacionURL?e[0].items?e[1]?(chainedSf=e[0].items.concat(e[1].items)).splice(8):chainedSf=e[0].items:e[1]&&(chainedSf=e[1].items):e[0]?chainedSf=e[0].items:console.log("Salesforce no devuelve encadenadas")},error:function(e,t,n){console.log("Error al recibir recomendadas desde SF: "+t+" "+n+" "+e.status+" "+e.statusText)}})}}function getLinkChainedById(t){var e=storeLinksChainedSf.filter(function(e){return e.content_id==t});return 0<e.length?(console.log("Devuelve link!!:"+e[0].link+" del ID: "+t),e[0].link):""}function getHrefTitle(e,t){var n=(e=(e=(e=(e=e.replace('<h2 class="notTitulo">','<p class="notTitulo">')).replace("</h2>","</p>")).replace('<h3 class="notSeccion">','<p class="notSeccion">')).replace("</h3>","</p>")).indexOf('<p class="notTitulo"><a href="'),i=e.indexOf('"',n+31),i=e.substr(n+30,i-(n+30));return e=(e=e.replace(i,t)).replace(i,t)}function getDateCurrent(){var e=new Date,t=e.getDate(),n=e.getFullYear(),e=e.getMonth()+1;return e<10&&(e="0"+e),t<10&&(t="0"+t),n.toString()+e.toString()+t.toString()}function sortJSON(e,n,i){return e.sort(function(e,t){return"asc"===i?e[n]-t[n]:"desc"===i?t[n]-e[n]:void 0})}function readJsonConsolaReglas(){try{var e="",t=new XMLHttpRequest,e=(cb_options.language,cb_options.storage_path+"config/console_rules.json");return t.open("GET",e,!1),t.send(null),sortJSON(JSON.parse(t.response),"priority","asc")}catch(e){return!1}}function getCountry(){try{var e=new XMLHttpRequest,t=(e.open("GET",cb_options.site_url+"/bbva-components/utils/info?&project="+cb_options.code_webs_publicas,!1),e.send(null),JSON.parse(e.response));return 200===t.code&&t.data&&t.data.country?(cb_options.user_country=t.data.country,t.data.country.toLowerCase()):!1}catch(e){return console.log("error country: "+e),!1}}function deleteCookie(e,t,n){var i=new Date,n=(i.setTime(i.getTime()+60*n*1e3),"expires="+i.toUTCString());document.cookie=e+"="+t+";"+n+";path=/"}function createCookieEncadenada(e,t,n){var i,n=n?((i=new Date).setTime(i.getTime()+24*n*60*60*1e3),"; expires="+i.toGMTString()):"";document.cookie=e+"="+t+n+"; path=/"}function removeInjectNews(e,t){t=e.indexOf(t);-1!==t&&e.splice(t,1)}function injectionNews(){var e=getDateCurrent(),t=new Array,n=readJsonConsolaReglas(),i="",i="local"===cb_options.env?cb_options.language:getCountry();if("false"!==n)for(var a=0;a<=n.length-1;a++){var o=(o=n[a].ruleStart.replace("-","")).replace("-",""),r=(r=n[a].ruleEnd.replace("-","")).replace("-",""),s=n[a].ruleArea;s===i||"all"===s?o<=e&&e<=r&&t.push(n[a].postID):o<=e&&e<=r&&"all"==s&&t.push(n[a].postID)}return t}0<urlActual.indexOf("/sostenibilidad/")?sostenibilidadURL=!0:0<urlActual.indexOf("/salud-financiera/")?saludFinancieraURL=!0:0<urlActual.indexOf("/juntos-creando-oportunidades/")?juntosURL=!0:0<urlActual.indexOf("/innovacion/")&&(innovacionURL=!0);var recomendadasInyectadas=injectionNews();function bloqueDescargaNewsletterEncadenadas(){var e=0,t=(jQuery(".bloquePremiumPasoSustainability1").each(function(){jQuery(this).attr("id","bloquePremiumEncadenada"+e),jQuery(this).find(".dataPremiumSustainability").find("input").attr("id","checkbox_agree_premium_sustainability"+e),jQuery(this).find(".dataPremiumSustainability").find("input").attr("name","agree_sustainability"+e),jQuery(this).find(".dataPremiumSustainability").find("label").attr("for","checkbox_agree_premium_sustainability"+e),jQuery(this).find(".notForm_inputMail").find("input").attr("id","newsletter-mail-sustainability"+e),jQuery(this).find(".notForm_groupBoton").find("button").attr("id","newsletter-submit-sustainability"+e),jQuery(this).find(".dataPremiumSustainability").attr("id","dataPremiumSustainability"+e),jQuery(this).find(".icon-nav_close").attr("id","notFormCerrarSustainability"+e),jQuery(this).find(".icoSpinner").attr("id","icoSpinnerSustainability"+e),e++}),0),n=(jQuery(".bloquePremiumPasoCurrent1").each(function(){jQuery(this).attr("id","bloquePremiumEncadenada"+t),jQuery(this).find(".dataPremiumCurrent").find("input").attr("id","checkbox_agree_premium_current"+t),jQuery(this).find(".dataPremiumCurrent").find("input").attr("name","agree_current"+t),jQuery(this).find(".dataPremiumCurrent").find("label").attr("for","checkbox_agree_premium_current"+t),jQuery(this).find(".notForm_inputMail").find("input").attr("id","newsletter-mail"+t),jQuery(this).find(".notForm_groupBoton").find("button").attr("id","newsletter-submit"+t),jQuery(this).find(".dataPremiumCurrent").attr("id","dataPremiumCurrent"+t),jQuery(this).find(".icon-nav_close").attr("id","notFormCerrar"+t),jQuery(this).find(".icoSpinner").attr("id","icoSpinner"+t),t++}),getCookie("downloadSustainabilityCookie")),i=getCookie("downloadCurrentCookie");""!=n?(jQuery(".blockSustainability1").each(function(){jQuery(this).addClass("hidden")}),jQuery(".blockSustainability3").each(function(){jQuery(this).removeClass("hidden")})):$(".blockSustainability1").each(function(){jQuery(this).find(".notFormInput").keyup(function(e){validateEmailPremium("sustainability",jQuery(this))}),$(this).find(".icon-nav_close").click(function(e){e=$("#"+e.target.id);e.parents().find(".notFormInput").val(""),validateEmailPremium("sustainability",e),e.parents().find(".notForm_inputMail").removeClass("error")}),$(this).find(".noticia_groupNewsForm .notForm_groupBoton .notFormBoton").click(function(e){e.preventDefault(),e.stopImmediatePropagation();var t=$("#"+e.target.id),n=e.target.id.replace("submit","mail"),n=$("#"+n),e=e.target.id.split("newsletter-submit-sustainability")[1];submitNewsletterFormPremium("sustainability",t,n,e)}),$(this).find(".dataPremiumSustainability input").change(function(e){e=$("#"+e.target.id);changeCheckPremium("sustainability",e)})}),""!=i?(jQuery(".blockCurrent1").each(function(){jQuery(this).addClass("hidden")}),jQuery(".blockCurrent3").each(function(){jQuery(this).removeClass("hidden")})):$(".blockCurrent1").each(function(){jQuery(this).find(".notFormInput").keyup(function(e){validateEmailPremium("current",jQuery(this))}),$(this).find(".notFormCerrar").click(function(e){e=jQuery("#"+e.target.id);e.parents().find(".notFormInput").val(""),validateEmailPremium("current",e),e.parents().find(".notForm_inputMail").removeClass("error")}),$(this).find(".noticia_groupNewsForm .notForm_groupBoton .notFormBoton").click(function(e){e.preventDefault(),e.stopImmediatePropagation();var t=$("#"+e.target.id),n=e.target.id.replace("submit","mail"),n=$("#"+n),e=e.target.id.split("newsletter-submit")[1];submitNewsletterFormPremium("current",t,n,e)}),$(this).find(".dataPremiumCurrent input").change(function(e){e=$("#"+e.target.id);changeCheckPremium("current",e)})})}function removeDuplicates(n){return n.filter((e,t)=>n.indexOf(e)===t)}function getNextInjectedRecommend(){for(var e="",t=getCookie("encadenadaCookie"),n=!0;n;)0<recomendadasInyectadas.length?(e=recomendadasInyectadas[0],"vacio"===t||""===t?(n=!1,createCookieEncadenada("encadenadaCookie",e,5)):t.indexOf(e)<0?(n=!1,createCookieEncadenada("encadenadaCookie",t+(","+e),5)):e="",recomendadasInyectadas.shift()):n=!1;return e}module("async-recommend",function(e,t,n){n=n.asyncRecommend;firstReading||onlyOneTime||showAdvertising(n),bloqueDescargaNewsletterEncadenadas(),currentNew=n}),module("load-more-content",function(d,e,t){var n=1e3*delaySeconds;firstReading||""==listEncadenadas?listEncadenadas+=t.loadMoreContent:""!=t.loadMoreContent&&(listEncadenadas+=","+t.loadMoreContent);var i=removeDuplicates(listEncadenadas.split(",")),t=i.indexOf(firstIdNewsReading);-1!==t&&i.splice(t,1);for(var a=1;a<i.length;a++)for(var o=1;o<totalIdsRelac.length;o++)i[a]==totalIdsRelac[o]&&i.splice(a,1);listEncadenadas=i.toString();function r(){var e;if(dbg.log("Cargar siguiente encadenada"),!(e=0<recomendadasInyectadas.length?getNextInjectedRecommend():e)||""===e)switch(typeRecommend){case"salesforce":e=getChainedSf();break;case"mediacenter":if(dbg.log("Encadenada manual"),totalIdsRelac.length<9){for(var t=listEncadenadas.split(","),n=t[0];totalIdsRelac.includes(n)&&1<t.length;)t.shift(),n=t[0];totalIdsRelac.includes(n)||(e=n,listEncadenadas=t.toString(),totalIdsRelac.push(e))}}if(e&&""!==e){chainedShowed.push(e);var i=e;if(cb_options.language=="en")i=i-parseInt(cb_options.ajuste_id_en);if(!firstReading){clearTimeout(isReading);isReading=null;s(i)}if(i!==""&&typeof Optanon!=="undefined"){i=cb_options.storage_info.replace(/{id}/gi,i);d.getJSON(i,function(e){if(e.link){var t=e.link.replace(/https?:\/\/[^\/]+/i,"");dbg.log("Cargamos la siguiente noticia: "+t+".",e);d.ajax({url:cb_options.site_url+t,success:function(e){cb_options.news_loaded++;if(typeof OnetrustActiveGroups!=="undefined"&&OnetrustActiveGroups.indexOf("C0003")!==-1)d(coronita_load_more_content_selector).addClass("content-loaded");var t=e.split(/<!-- CONTENT_START -->/)[1].split(/<!-- CONTENT_END -->/)[0];var n=t;if(cb_options.news_loaded%encadenadas_automaticas==0)d(coronita_load_more_content_selector).parent().append(n);window.coronita.ContentLoadNextArticle.createEventListeners();d(coronita_load_more_content_selector).remove();var i=e.split(/<!-- CONTENT_ARTICLE_START -->/)[1].split(/<!-- CONTENT_ARTICLE_END -->/)[0];var a='<div class="container-fluid next-article">'+i+"</div>";if(cb_options.news_loaded%encadenadas_automaticas==0)a='<div class="container-fluid next-article new-article-hidden" style="display: none">'+i+"</div>";d(".loading-article").parent().append(a);if(OnetrustActiveGroups.indexOf("C0003")!==-1)controlYoutubeSRC();var o=e.split(/<!-- CONTENT_START_ADOBE_DATALAYER -->/)[1].split(/<!-- CONTENT_END_ADOBE_DATALAYER -->/)[0];var r=e.split(/<!-- CONTENT_START_GOOGLE_DATALAYER -->/)[1].split(/<!-- CONTENT_END_GOOGLE_DATALAYER -->/)[0];window.coronita.portionDatalayers=o+r;d("main").append(window.coronita.portionDatalayers);if(typeof lazyLoadImages!=="undefined")lazyLoadImages();if(typeof ContentAuthorVerticalAlign!=="undefined")ContentAuthorVerticalAlign.Author();d(document.body).off(ContentLoadNextArticle.Main.EVENT_LOAD_NEXT_NEWS).on(ContentLoadNextArticle.Main.EVENT_LOAD_NEXT_NEWS,function(){coronita_finished=false;window.coronita.goTop.createEventListeners();window.coronita.contentTypeVideo.createEventListeners();window.coronita.contentTypeAudio.createEventListeners();window.coronita.ContentTypeAudioPlayer.createEventListeners();d("article #top").each(function(){var e=d(this).attr("class");var t=e.split(" ");var n="";for(var i=0;i<t.length;i++)if(t[i].indexOf("ContHeader")>0&&t[i].length>13)n=t[i];idWordpressEN=n.replace("detContHeader","")})});if(cb_options.news_loaded%encadenadas_automaticas!=0){var s=new CustomEvent(ContentLoadNextArticle.Main.EVENT_LOAD_NEXT_NEWS);document.body.dispatchEvent(s)}}})}})}else console.log("No se carga noticias encadenadas, no hay id")}}var s=function(t){isReading=setTimeout(()=>{var i,e;i=t,dbg.log("La noticia "+i+" ha sido leída y se notificará a Salesforce"),"en"==cb_options.language&&(""===idWordpressEN?d("article .detContContent").each(function(){for(var e=d(this).attr("class").split(" "),t="",n=0;n<e.length;n++)0<e[n].indexOf("ContContent")&&13<e[n].length&&(t=e[n]);idWordpressEN=t.replace("detContContent",""),i=idWordpressEN}):i=idWordpressEN),"undefined"==typeof OnetrustActiveGroups||-1===OnetrustActiveGroups.indexOf("C0003")||"https://www.integrado.bbva.com"!==cb_options.site_url&&"https://integrado.bbva.com"!==cb_options.site_url&&"https://www.bbva.com"!==cb_options.site_url||i!=trackPostID&&(scriptTrackItemDetail.text,e="prod"===cb_options.env?"500008614":"500008615",_etmc.push(["setOrgId",e]),_etmc.push(["trackPageView",{item:i}]),_etmc.push(["trackConversion",{cart:[{item:i,unique_id:i}]}]),""!=getLinkChainedById(i))&&(console.log("Enviamos chained"+getLinkChainedById(i)),d.ajax({url:getLinkChainedById(i),type:"GET",dataType:"jsonp",success:function(e,t,n){},error:function(e,t,n){}}))},n)};dbg.log("Comprobando si es relacionada o es la primera: ",firstReading),firstReading&&(firstReading=!1,clearTimeout(isReading),isReading=null,s(d("[data-async-recommend]").first().data("async-recommend")));d(window).scroll(d.throttle(defaultThrottle,function(){var e,t,n,i;coronita_finished||(e=jQuery("*[data-sticker]").length,e=jQuery(jQuery("*[data-sticker]")[e-1]),e=Math.floor(e.offset().top),i=d(window),t=d("main").height(),i=(n=i.scrollTop())+i.height(),e<=n&&t-800<i&&(coronita_finished=!0,"undefined"!=typeof Optanon&&Optanon.IsAlertBoxClosedAndValid()?r():(dbg.log("No se encadena hasta que se acepten las cookies"),coronita_finished=!1)))}))});
